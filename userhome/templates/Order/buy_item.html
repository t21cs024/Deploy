<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>食品購入</title>
</head>
<body>
  <video id="qr-video" width="300" height="200" autoplay></video>
  <script src="https://rawgit.com/cozmo/jsQR/master/dist/jsQR.js"></script>
  <script>
    const video = document.getElementById('qr-video');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then((stream) => {
        video.srcObject = stream;
        video.play();
        const canvasElement = document.createElement('canvas');
        const canvas = canvasElement.getContext('2d');
        setInterval(() => {
          canvasElement.width = video.videoWidth;
          canvasElement.height = video.videoHeight;
          canvas.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
          const imageData = canvas.getImageData(0, 0, video.videoWidth, video.videoHeight);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code) {
            console.log('QRコードの内容:', code.data);
         	// ここでQRコードのデータを利用する処理を記述します
            addToCart(code.data); // カートに追加する処理を呼び出し
            showMessage(`読み取りました: ${code.data}`);
          }
        }, 100);
      })
      .catch((err) => {
        console.error('カメラのアクセスを許可してください:', err);
      });
    
    function addToCart(item_id) {
        fetch(`/userhome/add_to_cart/${item_id}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'), // CSRFトークンを取得してヘッダーに含める
            },
            body: JSON.stringify({ quantity: 1 }), // 商品の数量などを必要に応じて送信
        })
            .then(response => response.json())
            .then(data => {
                console.log('カートに商品が追加されました:', data);
            })
            .catch(error => {
                console.error('エラーが発生しました:', error);
            });
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }
    function showMessage(text) {
        messageDiv.innerText = text;
    }
  </script>
</body>
<ul>

  <li><a href="{% url 'userhome:cartcontents' %}">カートに移動する</a></li>
  <li><a href='/userhome'>戻る</a></li>
</ul>
</html>

